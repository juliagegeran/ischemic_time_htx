---
title: Data prep for *Impact of Increasing Ischemic Time on Heart Transplantation Outcome*
author: "Julia (Gege) Ran, William Parker"
output:
  rmdformats::material:
    highlight: tango
  html_document:
    theme: cosmo
    toc: yes
---

# Loading Packages

This chunk is used to load in the packages in R that help us to tidy, manipulate, and visualize the data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

require("knitr")
opts_knit$set(root.dir = "C:/Users/julia/SRP/S&D/SharedFiles/pubsaf2103")

```

```{r library}
library(tidyverse)
library(haven)
library(rmdformats)
library(dplyr)
library("ggpubr")
```

# Data sources

Standard Scientific Registry of Transplant Recipients (SRTR) SAF files We uploaded all the relevant files that contained data for the study.

```{r data_in}
# read in the SRTR SAF files
##all thoracic transplant candidate information
cand_thor <- haven::read_sas("cand_thor.sas7bdat", NULL) %>%  
  zap_formats() %>% zap_labels()

#justification for status 1a
statjust_hr1a <- read_sas("statjust_hr1a.sas7bdat", NULL) %>%
  zap_formats() %>% zap_labels()

#justification for status 1b
statjust_hr1b <- read_sas("statjust_hr1b.sas7bdat", NULL) %>%
  zap_formats() %>% zap_labels()

#transplant result
tx_hr <- read_sas("tx_hr.sas7bdat", NULL) %>%  
  zap_formats() %>% zap_labels()

#center-level and opo-level predictors 
institution <- read_sas("institution.sas7bdat", NULL) %>%  
  zap_formats() %>% zap_labels()

opo <- read_sas("hist_opo_txc.sas7bdat", NULL) %>% 
  zap_formats() %>% zap_labels()

donor <- read_sas("donor_deceased.sas7bdat",NULL) %>% 
  zap_formats() %>%  zap_labels()

```

```{r new justification}
#justification for new statuses
setwd("C:/Users/julia/SRP/S&D/Thoracic/ThoracicRegistration/Thoracic_Justs")

#justification for new status 1
statjust_hr1 <- read_sas("JustFormHRStat1.sas7bdat", NULL) %>%  
  zap_formats() %>% zap_labels()

#justification for new status 2
statjust_hr2 <- read_sas("JustFormHRStat2.sas7bdat", NULL) %>% 
  zap_formats() %>% zap_labels()

#justification for new status 3
statjust_hr3 <- read_sas("JustFormHRStat3.sas7bdat", NULL) %>% 
  zap_formats() %>% zap_labels()

#justification for new status 4
statjust_hr4 <- read_sas("JustFormHRStat4.sas7bdat", NULL) %>% 
  zap_formats() %>% zap_labels()


#status justification and episodes
StatusJustEpisode <- read_sas("StatusJustEpisode.sas7bdat", NULL) %>% 
  zap_formats() %>% zap_labels()

#linking WlregAuditID to justification ID
JustFormHRDataLink <- read_sas("JustFormHRDataLink.sas7bdat", NULL) %>% 
  zap_formats() %>% zap_labels()

#linking WlregAuditID to Px_ID, the linking is copied from RiskStratDataHR
WlregAuditId_PxId <- read_sas("RiskStratDataHR.sas7bdat", NULL) %>% 
  zap_formats() %>% zap_labels() %>% select(WlregAuditId,PX_ID=px_id)

#JustFormHR
JustFormHR <- read_sas("JustFormHR.sas7bdat")
```

# Select study sample

## Define data ranges

This section specifics the dates used in the study. The dates can be modified by changing the date in this chunk of code.

```{r date_ranges}
start_date <- as.Date("2016-10-20")
end_date <- as.Date("2019-12-31")

#mark the end of the pre-policy cohort
pre_policy_end_date <- as.Date("2017-12-31")


#mark the start of the post-policy cohort
post_policy_start_date <- as.Date("2018-10-20")

policy_switch_date <- as.Date("2018-10-18")
```

## Filter initial listing

In this section, we select only adult, heart-only transplant recipients from sufficiently large transplant centers. The following exclusion criteria were applied:

1.  Age \<= 17 yo at the time of listing
2.  Recipient of multiple transplants
3.  Inactive listing status
4.  Transplant center conducted fewer than 5 heart-alone transplants in either of the two study periods
5.  Did not receive a transplant
6.  Had inappropriate listing status at the time of transplantation (e.g. had Status 1A/1B/2 assignment after the policy switch)

As a result, 6775 transplant recipients from 99 centers are included in further analyses.

```{r filter initial listing}
#keep multi-organ recipients to code as Status 5
multi <- TRUE

#exclude tranplant recipients <18 at the time of listing
peds <- FALSE

init_list <- tx_hr %>% 
  mutate(tx_date = REC_TX_DT) %>% 
  filter(tx_date >= start_date & tx_date <= end_date)  %>% 
  mutate(policy = case_when(
  tx_date <= pre_policy_end_date ~ paste0("Pre"),
  tx_date >= post_policy_start_date ~  paste0("Post"),
  tx_date >= pre_policy_end_date & tx_date <= post_policy_start_date ~ paste0("in-between"))) %>% 
  mutate(tx = ifelse(is.na(REC_TX_DT)== TRUE, 1,0)) %>% 
  filter(tx !=1, policy !="in-between") %>% #exclude candidates w/o transplant or tx-ed between outside the range of study periods
  mutate(center = REC_CTR_ID) %>% 
  filter(CAN_AGE_AT_LISTING >17) %>% #exclude peds
  filter(!(policy == "Post" & (CAN_LAST_STAT == 1010 | CAN_LAST_STAT == 2010)))

init_list %>% group_by(policy) %>% count()

#remove multiorgan recipients
if (multi == FALSE){
	multi_recips <- tx_hr %>% filter(REC_TX_TY == 2 | REC_TX_TY ==4) %>% select(PX_ID,REC_TX_TY)
  
	n_mults <- nrow(init_list %>% filter(PX_ID %in% multi_recips$PX_ID))
	
	init_list <- init_list %>% filter(!PX_ID %in% multi_recips$PX_ID)
	remove(multi_recips)
}

#filter out inactive listing 
init_list <- init_list %>%
  filter(CAN_LAST_STAT %in% 
           c(1010,1020,1030,1110,1120,1130,1140,1150,1160,
             2010,2020,2030,2110,2120,2130,2140,2150,2160)) 


#remove candidates transplanted at low volume centers
init_list <- init_list %>% 
  mutate(transplant = ifelse(CAN_REM_CD == 4, 1, 0)) %>%
	group_by(REC_CTR_ID,policy) %>% 
  mutate(tot_tx = replace_na(sum(transplant, na.rm = TRUE), 0)) %>% 
  ungroup() 

low_volume_centers <- init_list %>% 
  select(REC_CTR_ID , policy,tot_tx) %>% 
  group_by(REC_CTR_ID , policy) %>% 
  distinct() %>% 
  ungroup() %>% 
  spread(key = policy, value = tot_tx) %>% 
  mutate(Pre = replace_na(Pre, 0),
         Post = replace_na(Post,0)) %>% 
  filter(Pre <5 | Post < 5) %>% 
  select(REC_CTR_ID)

low_volume_center <- pull(low_volume_centers, REC_CTR_ID)

init_list <- init_list %>% 
  mutate(low_volume = ifelse(REC_CTR_ID  %in% low_volume_center, 1,0)) %>% 
  filter(low_volume !=1) 


#sanity check - 99 centers are in the study
n_centers <- init_list %>% 
  select(REC_CTR_ID , policy,tot_tx) %>% 
  group_by(REC_CTR_ID , policy) %>% 
  distinct() %>% 
  ungroup() %>% 
  spread(key = policy, value = tot_tx) %>% 
  mutate(Pre = replace_na(Pre, 0),
         Post = replace_na(Post,0)) %>% 
  nrow()

#3308 transplants pre-policy, 3499 post-policy. Two individuals in the post-policy period had Status 1A. They will be dropped. 
num_tx_period <- init_list %>% 
  select(PX_ID, policy, tx_date, CAN_LAST_STAT) %>% 
  group_by(policy) %>% 
  count()


```

# Identify Predictors of Post-Transplantation Mortality

Next, we identified variables most likely to impact an organ recipient's post-transplantation survival based on components of the IMPACT score:

1.  Age \> 60 years
2.  Serum bilirubin, mg/dl
3.  Dialysis between listing and transplant
4.  Female sex
5.  Heart failure etiology
6.  Recent infection
7.  Intra-aortic balloon pump
8.  Mechanical ventilation pre-transplant
9.  Race
10. Temporary circulatory support
11. Ventricular assist device

Other explanatory variables under consideration include 
12. functional status
13. ABO blood type
14. patient bmi
14. treatment received by the recipient immediately before transplantation.
15. educational background of the recipient

Additionally, we will identify the following outcome variables

1. death within 1-year post-transplantation (all causes)
2. re-transplantation within 1-year post-transplantation
3. date of graft failure (fatal and non-fatal)

```{r identify variables}

#with IMPACT score components, functional status, and ABO
init_list2 <- init_list %>% 
  select(PX_ID,
         policy,
         tx_date,
         status = CAN_LAST_STAT,
         center = REC_CTR_ID,
         rec_age = REC_AGE_IN_MONTHS_AT_TX/12,
         don_age = DON_AGE_IN_MONTHS/12,
         rec_edu = CAN_EDUCATION,
         rec_bmi = REC_BMI,
         bilirubin = REC_TOT_BILI,
         dialysis = REC_DIAL,
         sex = CAN_GENDER,
         diagnosis = CAN_DGN,
         infection = REC_INFECT_IV_DRUG,
         iabp = REC_IABP,
         vent = REC_VENTILATOR,
         vent_event = REC_VENTILATOR_SUPPORT,
         vent_timeframe = REC_VENTILATOR_TIMEFRAME,
         race = CAN_RACE,
         ecmo = REC_ECMO,
         vad = REC_VAD_TY,
         vad_b1 = REC_VAD1,
         vad_b2 = REC_VAD2,
         vad_tah = REC_VAD_TAH,
         rec_abo = CAN_ABO,
         don_abo = DON_ABO,
         fnt_status = REC_FUNCTN_STAT,
         last_stat = TFL_LASTATUS, 
         last_date = TFL_LAFUDATE,
         cod = TFL_COD, 
         gf_date = TFL_GRAFT_DT,
         death_date = TFL_DEATH_DT,
         ischemic_time = REC_HR_ISCH) %>% 
  mutate(
    graft_failed = ifelse(!is.na(gf_date),1,0),
         gf_1y = ifelse(!is.na(gf_date) & 
                          (as.Date(gf_date) - as.Date(tx_date) <365),
                        1,0),
         dead = ifelse(!is.na(death_date) & last_stat == "D", 
                       1,0),
         dead_1y = ifelse(!is.na(death_date) & 
                            (as.Date(death_date) - as.Date(tx_date) <365),
                          1,0),
         retx = ifelse(last_stat == "R",1,0)
  )

#sanity check 1: number of people who had graft failure by policy period
View(init_list2 %>% 
  group_by(policy,graft_failed) %>% 
  count() %>% 
  filter(graft_failed ==1))

#sanity check 2: number of recipients died of graft failure
View(init_list2 %>% 
       filter(graft_failed ==1 & dead == 1 & gf_date == death_date) %>% 
       group_by(policy) %>% 
       count())

#sanity check 3: number of recipients dying within the 1st year due to all causes
View(init_list2 %>% 
       filter(dead_1y == 1) %>% 
       group_by(policy) %>% 
       count())
#sanity check 4: when does graft failure happen
View(init_list2 %>% 
       filter(graft_failed ==1) %>% 
       mutate(gf_duration = as.Date(gf_date) - as.Date(tx_date)) %>% 
       select(policy,gf_duration))

#sanity check 5: how many people got re-transplanted after graft failure
View(init_list2 %>% 
       filter(graft_failed ==1 & last_stat == "R") %>% 
       group_by(policy) %>% 
       count())

#average ischemic time is significantly longer after policy change 
ggboxplot(init_list2, x = "policy", y = "ischemic_time", 
          color = "policy", palette = c("#00AFBB", "#E7B800"),
        ylab = "ischemic time", xlab = "policy period")

t.test(ischemic_time ~ policy, data = init_list2, var.equal = TRUE)

#transplant outcome  by policy period

ggplot(init_list2, aes(last_stat,n, fill=policy)) +
  geom_bar(stat = "identity", position = 'dodge')

## 495 total dead in post-policy vs 376 in pre-policy, 
##13 re-transplant in post-policy period vs 8 in pre-policy

test2 <- init_list2 %>% 
  select(policy,last_stat) %>% 
  group_by(policy,last_stat) %>% 
  count() %>% 


```

## Find recipient treatment at the time of transplantation
